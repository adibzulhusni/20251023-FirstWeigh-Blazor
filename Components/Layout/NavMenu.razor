@using FirstWeigh.Models
@using FirstWeigh.Services
@inject AuthenticationService AuthService
@inject NavigationManager Navigation
@implements IDisposable
@inject IJSRuntime JSRuntime

<div style="background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%); height: 60px; display: flex !important; align-items: center; padding: 0 2rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);">
    <a class="navbar-brand" href="" style="font-size: 1.3rem; font-weight: 700; color: white !important; margin-right: 3rem; text-decoration: none;">FirstWeigh System</a>

    <nav style="display: flex !important; flex-direction: row !important; gap: 0; flex: 1;">
        @if (AuthService.IsAuthenticated)
        {
            <!-- Dashboard - Admin, Developer, Supervisor only -->
            @if (AuthService.CurrentUser?.Role == UserRoles.Admin ||
                    AuthService.CurrentUser?.Role == UserRoles.Developer ||
                    AuthService.CurrentUser?.Role == UserRoles.Supervisor)
            {
                <div class="nav-item">
                    <NavLink class="nav-link" href="" Match="NavLinkMatch.All" style="display: flex; align-items: center; padding: 0.75rem 1.25rem; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; text-decoration: none;">
                        <span style="margin-right: 0.5rem;">🏠</span> Dashboard
                    </NavLink>
                </div>
            }

            <!-- Weighing - All roles -->
            <div class="nav-item">
                <NavLink class="nav-link" href="weighing" style="display: flex; align-items: center; padding: 0.75rem 1.25rem; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; text-decoration: none;">
                    <span style="margin-right: 0.5rem;">⚖️</span> Weighing
                </NavLink>
            </div>

            <!-- Production - All roles -->
            <div class="nav-item">
                <NavLink class="nav-link" href="production" style="display: flex; align-items: center; padding: 0.75rem 1.25rem; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; text-decoration: none;">
                    <span style="margin-right: 0.5rem;">🏭</span> Production
                </NavLink>
            </div>

            <!-- Batches - Admin, Developer, Supervisor only -->
            @if (AuthService.CurrentUser?.Role == UserRoles.Admin ||
                    AuthService.CurrentUser?.Role == UserRoles.Developer ||
                    AuthService.CurrentUser?.Role == UserRoles.Supervisor)
            {
                <div class="nav-item">
                    <NavLink class="nav-link" href="batches" style="display: flex; align-items: center; padding: 0.75rem 1.25rem; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; text-decoration: none;">
                        <span style="margin-right: 0.5rem;">📦</span> Batches
                    </NavLink>
                </div>
            }

            <!-- Recipes - Admin, Developer only -->
            @if (AuthService.CurrentUser?.Role == UserRoles.Admin ||
                    AuthService.CurrentUser?.Role == UserRoles.Developer)
            {
                <div class="nav-item">
                    <NavLink class="nav-link" href="recipes" style="display: flex; align-items: center; padding: 0.75rem 1.25rem; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; text-decoration: none;">
                        <span style="margin-right: 0.5rem;">📋</span> Recipes
                    </NavLink>
                </div>
            }

            <!-- Ingredients - Admin, Developer, Supervisor only -->
            @if (AuthService.CurrentUser?.Role == UserRoles.Admin ||
                    AuthService.CurrentUser?.Role == UserRoles.Developer)
            {
                <div class="nav-item">
                    <NavLink class="nav-link" href="ingredients" style="display: flex; align-items: center; padding: 0.75rem 1.25rem; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; text-decoration: none;">
                        <span style="margin-right: 0.5rem;">🧪</span> Ingredients
                    </NavLink>
                </div>
            }

            <!-- Bowls - All roles -->
            <div class="nav-item">
                <NavLink class="nav-link" href="bowls" style="display: flex; align-items: center; padding: 0.75rem 1.25rem; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; text-decoration: none;">
                    <span style="margin-right: 0.5rem;">🥣</span> Bowls
                </NavLink>
            </div>

            <!-- Users - Admin, Developer only -->
            @if (AuthService.CurrentUser?.Role == UserRoles.Admin ||
                    AuthService.CurrentUser?.Role == UserRoles.Developer)
            {
                <div class="nav-item">
                    <NavLink class="nav-link" href="users" style="display: flex; align-items: center; padding: 0.75rem 1.25rem; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; text-decoration: none;">
                        <span style="margin-right: 0.5rem;">👥</span> Users
                    </NavLink>
                </div>
            }

            <!-- Reports - Admin, Developer, Supervisor only -->
            @if (AuthService.CurrentUser?.Role == UserRoles.Admin ||
                    AuthService.CurrentUser?.Role == UserRoles.Developer ||
                    AuthService.CurrentUser?.Role == UserRoles.Supervisor)
            {
                <div class="nav-item">
                    <NavLink class="nav-link" href="reports" style="display: flex; align-items: center; padding: 0.75rem 1.25rem; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; text-decoration: none;">
                        <span style="margin-right: 0.5rem;">📊</span> Reports
                    </NavLink>
                </div>
            }
        }
    </nav>

    <!-- User Info and Logout (Right Side) -->
    @if (AuthService.IsAuthenticated)
    {
        <div style="display: flex; align-items: center; gap: 1rem; margin-left: auto;">
            <span style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem;">
                Welcome, @AuthService.CurrentUser?.Username | @AuthService.CurrentUser?.Role
            </span>
            <button @onclick="HandleLogout"
                    style="background-color: #e53e3e; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                Logout
            </button>
        </div>
    }
</div>

@code {
    protected override void OnInitialized()
    {
        // Subscribe to auth state changes
        AuthService.OnAuthenticationStateChanged += HandleAuthStateChanged;
    }

    private void HandleAuthStateChanged(CurrentUserInfo? user)
    {
        // Force UI update when auth state changes
        InvokeAsync(StateHasChanged);
    }
    private async Task HandleLogout()
    {
        try
        {
            await AuthService.LogoutAsync();

            // Small delay to ensure state is cleared
            await Task.Delay(100);

            // Navigate with force reload
            Navigation.NavigateTo("/login", forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Logout error: {ex.Message}");
            // Force navigation anyway
            Navigation.NavigateTo("/login", forceLoad: true);
        }
    }
    public void Dispose()
    {
        // Unsubscribe from auth state changes
        AuthService.OnAuthenticationStateChanged -= HandleAuthStateChanged;
    }
}