@page "/weighing"
@page "/weighing/{BatchId}"
@using FirstWeigh.Models
@using FirstWeigh.Services
@inject IWeighingService WeighingService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable
@inject ModbusScaleService ModbusService
@inject BowlService BowlService
@inject AuthenticationService AuthService

<style>
    /* ========== ULTRA COMPACT FOR ALL SCREENS ========== */
    * {
        box-sizing: border-box;
    }

    .weighing-container {
        min-height: 100vh;
        background-color: #f5f7fa;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* ✅ HEADER - COMPACT WITH BIGGER BUTTONS */
    .weighing-header {
        background: white;
        border-bottom: 1px solid #e2e8f0;
        padding: 4px 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-info {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 1px;
    }

    .info-label {
        font-size: 8px;
        color: #718096;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        font-weight: 600;
    }

    .info-value {
        font-size: 11px;
        color: #1a202c;
        font-weight: 600;
        font-family: 'Roboto Mono', monospace;
    }

    .header-actions {
        display: flex;
        gap: 8px;
    }

    /* ✅ BIGGER ACTION BUTTONS */
    .btn-pause,
    .btn-abort,
    .btn-start-modbus,
    .btn-stop-modbus {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 700;
        cursor: pointer;
        border: none;
        color: white;
        min-height: 36px;
    }

    .btn-pause {
        background-color: #ed8936;
    }

    .btn-abort {
        background-color: #f56565;
    }

    .btn-start-modbus {
        background-color: #48bb78;
    }

    .btn-stop-modbus {
        background-color: #718096;
    }

    /* CONTENT AREA */
    .weighing-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 5px;
        gap: 5px;
        width: 100%;
        overflow-y: auto;
        max-height: calc(100vh - 40px);
        scroll-behavior: smooth;
    }

    /* STAGE INDICATOR */
    .stage-indicator {
        background: white;
        border-radius: 6px;
        padding: 5px 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .stage-title {
        font-size: 9px;
        font-weight: 600;
        color: #718096;
        margin-bottom: 3px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .stage-progress {
        display: flex;
        gap: 5px;
        align-items: center;
    }

    .stage-step {
        flex: 1;
        padding: 4px 6px;
        border-radius: 4px;
        text-align: center;
        font-weight: 600;
        transition: all 0.3s;
        border: 1px solid #e2e8f0;
        font-size: 9px;
        line-height: 1.2;
    }

        .stage-step.active {
            background: linear-gradient(135deg, #4a9eff, #3a8ee6);
            color: white;
            border-color: #4a9eff;
        }

        .stage-step.completed {
            background: #c6f6d5;
            color: #22543d;
            border-color: #48bb78;
        }

        .stage-step.pending {
            background: #f7fafc;
            color: #a0aec0;
        }

    /* ✅ SCALE CARDS - DYNAMIC SIZING */
    .scale-card {
        background: white;
        border-radius: 8px;
        padding: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
        scroll-margin-top: 50px;
    }

        /* Scale 1 - FILLS ENTIRE SCREEN */
        .scale-card.scale-1-active {
            min-height: calc(100vh - 100px);
            flex: 1;
        }

        /* Scale 2 - Compact when waiting */
        .scale-card.scale-2-waiting {
            flex: 1;
            min-height: auto;
            position: relative;
        }

        /* Scale 2 - Expanded during transfer */
        .scale-card.scale-2-active {
            min-height: 70vh;
            flex: 4;
        }

        .scale-card.scale-2-waiting .scale-header::after {
            content: "⬇️ Transfer section ready below";
            display: block;
            text-align: center;
            font-size: 8px;
            color: #4a9eff;
            padding: 4px;
            background: #e6f7ff;
            border-radius: 4px;
            margin-top: 4px;
            font-weight: 600;
        }

        .scale-card.scale-2-active .scale-header::after {
            display: none;
        }

    .scale-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e2e8f0;
    }

    .scale-title-section {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .scale-label {
        font-size: 13px;
        font-weight: 700;
        color: #4a9eff;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .scale-subtitle {
        font-size: 11px;
        color: #718096;
        font-weight: 600;
    }

    /* ✅ BIGGER INGREDIENT CODE */
    .ingredient-code {
        font-family: 'Roboto Mono', monospace;
        font-size: 24px;
        font-weight: 700;
        color: #1a202c;
        background: linear-gradient(135deg, #4a9eff, #3a8ee6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* ✅ BIGGER BOWL BADGES */
    .bowl-size-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        background: #e6f7ff;
        border: 2px solid #4a9eff;
        border-radius: 16px;
        font-weight: 700;
        color: #2c5282;
        font-size: 12px;
    }

    /* ✅ MASSIVE PERCENTAGE DISPLAY - SHIFTED UP */
    .percentage-display {
        text-align: center;
        margin: 0;
        flex: 0.8;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px 0 10px 0;
    }

    ..percentage-value {
        font-family: 'Roboto Mono', monospace;
        font-size: 120px !important;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 8px;
    }

    .percentage-label {
        font-size: 16px;
        color: #718096;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 5px;
    }

    /* ✅ PROGRESS BAR - SHIFTED UP */
    .progress-section {
        margin: 15px 0;
    }

    .progress-bar-container {
        position: relative;
        height: 50px;
        background: #e2e8f0;
        border-radius: 25px;
        overflow: hidden;
        margin-bottom: 10px;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #f56565 0%, #ed8936 40%, #ecc94b 60%, #48bb78 80%, #38a169 100%);
        border-radius: 25px;
        transition: width 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .progress-percentage {
        font-size: 18px;
        font-weight: 700;
        color: white;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* ✅ STATUS BANNER - SHIFTED UP */
    .status-section {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 16px 20px;
        border-radius: 8px;
        margin: 0;
    }

        .status-section.red {
            background: linear-gradient(135deg, #fed7d7, #fc8181);
        }

        .status-section.yellow {
            background: linear-gradient(135deg, #feebc8, #fbd38d);
        }

        .status-section.green {
            background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
        }

    .status-icon {
        font-size: 32px;
    }

    .status-text {
        font-size: 16px;
        font-weight: 700;
        color: #1a202c;
    }

    /* ✅ BIGGER BUTTONS */
    .btn-complete {
        width: 100%;
        background: linear-gradient(135deg, #48bb78, #38a169);
        color: white;
        border: none;
        padding: 14px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        letter-spacing: 1px;
        min-height: 50px;
    }

        .btn-complete:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn-complete:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

    /* EMPTY STATE */
    .empty-weighing {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 30px 15px;
    }

    .empty-content {
        max-width: 300px;
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.3;
    }

    .empty-title {
        font-size: 18px;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 8px;
    }

    .empty-text {
        font-size: 13px;
        color: #718096;
        margin-bottom: 15px;
    }

    .btn-start {
        background-color: #4a9eff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
    }

    /* MODALS */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .modal-content {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        padding: 10px 12px;
        border-bottom: 1px solid #e2e8f0;
    }

    .modal-title {
        font-size: 13px;
        font-weight: 600;
        color: #1a202c;
        margin: 0;
    }

    .modal-body {
        padding: 10px 12px;
    }

        .modal-body p {
            font-size: 11px;
            margin-bottom: 8px;
        }

        .modal-body label {
            display: block;
            font-size: 10px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 4px;
        }

        .modal-body textarea,
        .modal-body input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 11px;
            font-family: 'Inter', sans-serif;
        }

        .modal-body textarea {
            resize: vertical;
            min-height: 50px;
        }

        .modal-body > div {
            margin-bottom: 10px;
        }

    .modal-footer {
        padding: 8px 12px;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }

    .btn-secondary {
        background-color: #e2e8f0;
        color: #4a5568;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-danger {
        background-color: #f56565;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-primary {
        background-color: #4a9eff;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
    }

    /* ========================================= */
    /* ✅ STAGE 1 - BIGGER COMPONENTS */
    /* ========================================= */

    .weighing-content > div > div[style*="display: flex"][style*="gap: 32px"] > div {
        padding: 16px !important;
    }

    .weighing-content > div > div[style*="display: flex"][style*="gap: 32px"] .percentage-label {
        font-size: 13px !important;
        font-weight: 700 !important;
        margin-bottom: 12px !important;
    }

    /* Bigger dropdowns in Stage 1 */
    .weighing-content select {
        padding: 12px 14px !important;
        font-size: 13px !important;
        font-weight: 600 !important;
        border: 2px solid #4a9eff !important;
    }

    /* ✅ COMPACT SELECTED BOWL BANNER */
    .weighing-content > div > div > div[style*="margin: 16px 0"][style*="padding: 16px"][style*="background: #fff3cd"] {
        padding: 6px !important;
        margin: 8px 0 !important;
    }

        .weighing-content > div > div > div[style*="margin: 16px 0"][style*="padding: 16px"][style*="background: #fff3cd"] p {
            font-size: 10px !important;
        }

    /* ✅ COMPACT BOWL VERIFIED BANNER */
    .weighing-content > div > div > div[style*="padding: 20px"][style*="background: #c6f6d5"] {
        padding: 8px !important;
        margin: 8px 0 !important;
    }

        .weighing-content > div > div > div[style*="padding: 20px"][style*="background: #c6f6d5"] span[style*="font-size: 32px"] {
            font-size: 20px !important;
            margin-bottom: 3px !important;
        }

        .weighing-content > div > div > div[style*="padding: 20px"][style*="background: #c6f6d5"] span[style*="font-size: 16px"],
        .weighing-content > div > div > div[style*="padding: 20px"][style*="background: #c6f6d5"] span[style*="font-weight: 700"] {
            font-size: 11px !important;
        }

    /* ✅ SMALLER VERIFY BOWL BUTTON */
    .weighing-content .btn-complete[style*="font-size: 14px"][style*="padding: 12px"] {
        padding: 8px 12px !important;
        font-size: 11px !important;
        min-height: 36px !important;
        margin-top: 12px !important;
    }

    /* ✅ COMPACT WARNING BANNER (Stage 1) */
    .weighing-content > div > div[style*="background: #fff3cd"][style*="padding: 24px"] {
        padding: 8px 12px !important;
        margin-bottom: 10px !important;
    }

    .weighing-content > div > div[style*="background: #fff3cd"] span[style*="font-size: 48px"] {
        font-size: 20px !important;
    }

    .weighing-content > div > div[style*="background: #fff3cd"] p[style*="font-size: 18px"] {
        font-size: 11px !important;
        margin-bottom: 2px !important;
    }

    .weighing-content > div > div[style*="background: #fff3cd"] p[style*="font-size: 14px"] {
        font-size: 10px !important;
    }

    /* ✅ COMPACT TRANSFER STATUS BOXES */
    .weighing-content > div > div[style*="margin-top: 24px"][style*="padding: 20px"] {
        padding: 10px 14px !important;
        margin-top: 12px !important;
    }

        .weighing-content > div > div[style*="margin-top: 24px"][style*="padding: 20px"] div[style*="font-size: 32px"] {
            font-size: 24px !important;
            margin-bottom: 6px !important;
        }

        .weighing-content > div > div[style*="margin-top: 24px"][style*="padding: 20px"] p[style*="font-size: 16px"] {
            font-size: 12px !important;
        }

        .weighing-content > div > div[style*="margin-top: 24px"][style*="padding: 20px"] p[style*="font-size: 13px"] {
            font-size: 10px !important;
        }

    /* Bigger bowl info boxes in Stage 1 */
    .weighing-content > div > div > div[style*="background: #e6f7ff"] {
        padding: 16px !important;
    }

        .weighing-content > div > div > div[style*="background: #e6f7ff"] p {
            font-size: 13px !important;
            font-weight: 700 !important;
        }
</style>

<div class="weighing-container">
    @if (session == null)
    {
        <!-- Empty State -->
        <div class="empty-weighing">
            <div class="empty-content">
                <div class="empty-icon">⚖️</div>
                <h2 class="empty-title">No Active Weighing Session</h2>
                <p class="empty-text">Select a batch from the Production page to start weighing</p>
                <button class="btn-start" @onclick="GoToProduction">Go to Production</button>
            </div>
        </div>
    }
    else
    {
        <!-- Header -->
        <div class="weighing-header">
            <div class="header-info">
                <div class="info-item">
                    <span class="info-label">Batch Code</span>
                    <span class="info-value">@session.BatchId</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Repetition</span>
                    <span class="info-value">@session.CurrentRepetition of @session.TotalRepetitions</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Ingredient</span>
                    <span class="info-value">@(session.CurrentIngredientIndex + 1) of @session.TotalIngredients</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Operator</span>
                    <span class="info-value" style="color: #4a9eff;">@(string.IsNullOrEmpty(currentLoggedInUser) ? session.OperatorName : currentLoggedInUser)</span>
                </div>
            </div>
            <div class="header-actions">
                @if (!isModbusReading)
                {
                    <button class="btn-start-modbus" @onclick="StartModbusReading">▶ Start Scales</button>
                }
                else
                {
                    <button class="btn-stop-modbus" @onclick="StopModbusReading">⏹ Stop Scales</button>
                }
                <button class="btn-pause" @onclick="PauseSession">⏸ Pause</button>
                <button class="btn-abort" @onclick="OpenAbortModal">⛔ Abort</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="weighing-content" id="weighing-content">
            <!-- Stage Indicator -->
            <div class="stage-indicator">
                <div class="stage-title">Weighing Process</div>
                <div class="stage-progress">
                    <div class="stage-step @(session.CurrentStage == WeighingStage.PlaceBowls ? "active" : session.CurrentStage > WeighingStage.PlaceBowls ? "completed" : "pending")">
                        <div>📥 Stage 1</div>
                        <div style="font-size: 12px; margin-top: 4px;">Place Bowls</div>
                    </div>
                    <div class="stage-step @(session.CurrentStage == WeighingStage.WeighIngredient ? "active" : session.CurrentStage > WeighingStage.WeighIngredient ? "completed" : "pending")">
                        <div>⚖️ Stage 2</div>
                        <div style="font-size: 12px; margin-top: 4px;">Weigh Ingredient</div>
                    </div>
                    <div class="stage-step @(session.CurrentStage == WeighingStage.Transfer ? "active" : "pending")">
                        <div>🔄 Stage 3</div>
                        <div style="font-size: 12px; margin-top: 4px;">Transfer</div>
                    </div>
                </div>
            </div>

            <!-- STAGE 1: Bowl Selection -->
            @if (session.CurrentStage == WeighingStage.PlaceBowls)
            {
                <div class="scale-card">
                    <div class="scale-header">
                        <div class="scale-title-section">
                            <span class="scale-label">STAGE 1: SELECT & VERIFY BOWLS</span>
                            <span class="scale-subtitle">Current Ingredient: @session.CurrentIngredient?.IngredientCode</span>
                        </div>
                    </div>

                    @if (!isModbusReading)
                    {
                        <div style="padding: 24px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; margin-bottom: 32px;">
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <span style="font-size: 48px;">⚠️</span>
                                <div>
                                    <p style="margin: 0; font-weight: 700; color: #856404; font-size: 18px; margin-bottom: 8px;">
                                        Scales Must Be Running
                                    </p>
                                    <p style="margin: 0; color: #856404; font-size: 14px;">
                                        Click "Start Scales" in the header above before selecting bowls.
                                    </p>
                                </div>
                            </div>
                        </div>
                    }

                    <div style="display: flex; gap: 32px; opacity: @(isModbusReading ? "1" : "0.5"); pointer-events: @(isModbusReading ? "auto" : "none");">
                        <!-- Ingredient Bowl Selection -->
                        <div style="flex: 1; padding: 24px; background: #f7fafc; border-radius: 12px; border: 2px solid @(ingredientBowlVerified ? "#48bb78" : "#e2e8f0");">
                            <div class="percentage-label" style="text-align: center; font-size: 14px; margin-bottom: 16px;">Scale 1: Ingredient Bowl</div>
                            <div class="bowl-size-badge" style="margin: 16px auto; display: inline-flex; width: 100%; justify-content: center;">
                                🥣 @session.CurrentIngredient?.BowlSize Bowl Required
                            </div>

                            <div style="margin: 24px 0;">
                                <select style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-family: 'Roboto Mono', monospace; position: relative; z-index: 1000;"
                                        @bind="selectedIngredientBowlCode"
                                        @bind:after="OnIngredientBowlSelected"
                                        disabled="@ingredientBowlVerified">
                                    <option value="">-- Select @session.CurrentIngredient?.BowlSize Bowl --</option>
                                    @foreach (var bowl in availableIngredientBowls)
                                    {
                                        <option value="@bowl.BowlCode">@bowl.BowlCode</option>
                                    }
                                </select>
                            </div>

                            @if (!string.IsNullOrEmpty(selectedIngredientBowlCode))
                            {
                                <div style="margin: 16px 0; padding: 16px; background: #fff3cd; border-radius: 8px; text-align: center;">
                                    <p style="margin: 0; font-size: 14px; color: #856404; font-weight: 600;">
                                        Selected Bowl: <strong>@selectedIngredientBowlCode</strong>
                                    </p>
                                </div>
                            }

                            @if (ingredientBowlVerified)
                            {
                                <div style="padding: 20px; background: #c6f6d5; border-radius: 8px; text-align: center; margin: 24px 0;">
                                    <span style="font-size: 32px; display: block; margin-bottom: 8px;">✓</span>
                                    <span style="color: #22543d; font-weight: 700; font-size: 16px;">Bowl Verified</span>
                                </div>
                            }
                            else if (!string.IsNullOrEmpty(selectedIngredientBowlCode))
                            {
                                <button class="btn-complete" @onclick="VerifyIngredientBowl" style="font-size: 14px; padding: 12px; margin-top: 24px;">
                                    ✓ Verify Bowl
                                </button>
                            }
                        </div>

                        <!-- Mixing Bowl Selection - ONLY FIRST INGREDIENT -->
                        @if (session.CurrentIngredientIndex == 0)
                        {
                            <div style="flex: 1; padding: 24px; background: #f7fafc; border-radius: 12px; border: 2px solid @(mixingBowlVerified ? "#48bb78" : "#e2e8f0");">
                                <div class="percentage-label" style="text-align: center; font-size: 14px; margin-bottom: 16px;">Scale 2: Mixing Bowl</div>
                                <div class="bowl-size-badge" style="margin: 16px auto; display: inline-flex; width: 100%; justify-content: center;">
                                    🥣 Mixing Bowl (Cumulative)
                                </div>

                                <div style="margin: 24px 0;">
                                    <select style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-family: 'Roboto Mono', monospace; position: relative; z-index: 1000;"
                                            @bind="selectedMixingBowlCode"
                                            @bind:after="OnMixingBowlSelected"
                                            disabled="@mixingBowlVerified">
                                        <option value="">-- Select Mixing Bowl --</option>
                                        @foreach (var bowl in availableMixingBowls)
                                        {
                                            <option value="@bowl.BowlCode">@bowl.BowlCode</option>
                                        }
                                    </select>
                                </div>

                                @if (!string.IsNullOrEmpty(selectedMixingBowlCode))
                                {
                                    <div style="margin: 16px 0; padding: 16px; background: #fff3cd; border-radius: 8px; text-align: center;">
                                        <p style="margin: 0; font-size: 14px; color: #856404; font-weight: 600;">
                                            Selected Bowl: <strong>@selectedMixingBowlCode</strong>
                                        </p>
                                    </div>
                                }

                                @if (mixingBowlVerified)
                                {
                                    <div style="padding: 20px; background: #c6f6d5; border-radius: 8px; text-align: center; margin: 24px 0;">
                                        <span style="font-size: 32px; display: block; margin-bottom: 8px;">✓</span>
                                        <span style="color: #22543d; font-weight: 700; font-size: 16px;">Bowl Verified</span>
                                    </div>
                                }
                                else if (!string.IsNullOrEmpty(selectedMixingBowlCode))
                                {
                                    <button class="btn-complete" @onclick="VerifyMixingBowl" style="font-size: 14px; padding: 12px; margin-top: 24px;">
                                        ✓ Verify Bowl
                                    </button>
                                }
                            </div>
                        }
                        else
                        {
                            <!-- Show Scale 2 info for subsequent ingredients -->
                            <div style="flex: 1; padding: 24px; background: #e6f7ff; border-radius: 12px; border: 2px solid #4a9eff;">
                                <div class="percentage-label" style="text-align: center; font-size: 14px; margin-bottom: 16px;">Scale 2: Mixing Bowl</div>
                                <div style="text-align: center; padding: 16px;">
                                    <p style="margin: 0; color: #0c5460; font-size: 14px; font-weight: 600;">
                                        📝 Mixing Bowl: @session.SelectedMixingBowlCode
                                    </p>
                                </div>
                                <div style="padding: 20px; background: #c6f6d5; border-radius: 8px; text-align: center; margin: 24px 0;">
                                    <span style="font-size: 32px; display: block; margin-bottom: 8px;">✓</span>
                                    <span style="color: #22543d; font-weight: 700; font-size: 16px;">Mixing Bowl On Scale 2</span>
                                </div>
                            </div>
                        }
                    </div>

                    <button class="btn-complete"
                            @onclick="RecordBowlsAndContinue"
                            disabled="@(!ingredientBowlVerified || (session.CurrentIngredientIndex == 0 && !mixingBowlVerified))"
                            style="margin-top: 32px;">
                        ✓ CONTINUE TO WEIGHING
                    </button>
                </div>
            }

            <!-- ✅ STAGE 2: Weigh Ingredient (Scale 1 - EXPANDED) -->
            @if (session.CurrentStage == WeighingStage.WeighIngredient && !isInTransferStage)
            {
                <div class="scale-card scale-1-active" id="scale1-card">
                    <div class="scale-header">
                        <div class="scale-title-section">
                            <span class="scale-label">STAGE 2: WEIGH INGREDIENT</span>
                            <span class="scale-subtitle">Add ingredient to bowl on Scale 1</span>
                        </div>
                        <div class="ingredient-code">@session.CurrentIngredient?.IngredientCode</div>
                    </div>

                    <div class="percentage-display">
                        <div class="percentage-label">INGREDIENT PROGRESS</div>
                        <div class="percentage-value" style="color: @GetPercentageColor(netProgress);">
                            @netProgress<span style="font-size: 100px;">%</span>
                        </div>
                    </div>

                    <div class="progress-section">
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: @netProgress%">
                                @if (netProgress > 15)
                                {
                                    <span class="progress-percentage">@netProgress%</span>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="status-section @netStatus.statusColor">
                        <span class="status-icon">@netStatus.statusIcon</span>
                        <span class="status-text">@netStatus.statusMessage</span>
                    </div>

                    <button class="btn-complete" disabled="@(!netStatus.canComplete)" @onclick="ReadyToTransfer">
                        ✓ READY TO TRANSFER
                    </button>
                </div>
            }

            <!-- ✅ Scale 2 - COMPACT when waiting, EXPANDED during transfer -->
            @if (session.CurrentStage == WeighingStage.WeighIngredient)
            {
                <div class="scale-card @(isInTransferStage ? "scale-2-active" : "scale-2-waiting")" id="scale2-card">
                    <div class="scale-header">
                        <div class="scale-title-section">
                            <span class="scale-label">SCALE 2 - CUMULATIVE PROGRESS</span>
                            <span class="scale-subtitle">Mixture Bowl Total</span>
                        </div>
                    </div>

                    <div style="padding: 20px; background: #e6f7ff; border-radius: 8px; margin-bottom: 16px; text-align: center;">
                        <p style="margin: 0; color: #0c5460; font-size: 13px; font-weight: 600;">
                            📝 Mixing Bowl: @session.SelectedMixingBowlCode
                        </p>
                    </div>

                    <div class="percentage-display">
                        <div class="percentage-label">BATCH COMPLETION</div>
                        <div class="percentage-value" style="color: @GetPercentageColor(scale2Progress);">
                            @scale2Progress<span style="font-size: 48px;">%</span>
                        </div>
                    </div>

                    <div class="progress-section">
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: @scale2Progress%">
                                @if (scale2Progress > 15)
                                {
                                    <span class="progress-percentage">@scale2Progress%</span>
                                }
                            </div>
                        </div>
                    </div>

                    @if (isInTransferStage)
                    {
                        <div style="margin-top: 24px; padding: 20px; background: @(transferWeightMatches ? "linear-gradient(135deg, #c6f6d5, #9ae6b4)" : "linear-gradient(135deg, #fff3cd, #ffeaa7)");
                                                                                                border: 3px solid @(transferWeightMatches ? "#48bb78" : "#ffc107"); border-radius: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 8px;">
                                    @(transferWeightMatches ? "✅" : "⏳")
                                </div>
                                <p style="margin: 0; font-size: 16px; font-weight: 700; color: @(transferWeightMatches ? "#22543d" : "#856404");">
                                    @(transferWeightMatches ? "Transfer Complete!" : "Transferring Material...")
                                </p>
                                <p style="margin: 8px 0 0 0; font-size: 13px; color: @(transferWeightMatches ? "#22543d" : "#856404");">
                                    @(transferWeightMatches ? "Click button below to continue" : "Waiting for correct weight on Scale 2")
                                </p>
                            </div>
                        </div>

                        <button class="btn-complete"
                                disabled="@(!transferWeightMatches)"
                                @onclick="ConfirmTransfer"
                                style="margin-top: 20px; background: @(transferWeightMatches ? "#28a745" : "#cbd5e0");
                                                                                                   cursor: @(transferWeightMatches ? "pointer" : "not-allowed");
                                                                                                   opacity: @(transferWeightMatches ? "1" : "0.5");">
                            @(transferWeightMatches ? "✓ COMPLETE TRANSFER" : "⏳ WAITING...")
                        </button>
                    }
                    else
                    {
                        <div class="status-section green">
                            <span class="status-icon">✓</span>
                            <span class="status-text">Tracking Total</span>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

<!-- Abort Modal -->
@if (showAbortModal)
{
    <div class="modal-overlay" @onclick="CloseAbortModal">
        <div class="modal-content" @onclick:stopPropagation="true" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">⚠️ Abort Weighing Session</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px;">
                    Are you sure you want to abort batch <strong>@session?.BatchId</strong>?
                </p>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; font-weight: 600; color: #4a5568; margin-bottom: 8px;">
                        Abort Reason *
                    </label>
                    <textarea class="form-control" @bind="abortReason" rows="4"
                              placeholder="Please explain why this weighing session is being aborted..."
                              style="width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px; font-family: 'Inter', sans-serif; resize: vertical;"></textarea>
                    @if (showValidation && string.IsNullOrWhiteSpace(abortReason))
                    {
                        <span style="color: #e53e3e; font-size: 12px; display: block; margin-top: 6px;">
                            Abort reason is required
                        </span>
                    }
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; font-weight: 600; color: #4a5568; margin-bottom: 8px;">
                        Aborted By *
                    </label>
                    <input type="text" class="form-control" @bind="abortedBy"
                           placeholder="Enter your name"
                           style="width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 14px;" />
                    @if (showValidation && string.IsNullOrWhiteSpace(abortedBy))
                    {
                        <span style="color: #e53e3e; font-size: 12px; display: block; margin-top: 6px;">
                            Name is required
                        </span>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @onclick="CloseAbortModal">Cancel</button>
                <button class="btn-danger" @onclick="ConfirmAbort">Abort Session</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string? BatchId { get; set; }

    private WeighingSession? session;
    private CancellationTokenSource? _cancellationTokenSource;
    private bool showAbortModal = false;
    private bool isModbusReading = false;
    private bool isModbusConnected = false;

    private bool isInTransferStage = false;
    private bool transferWeightMatches = false;

    private decimal scale1Weight => ModbusService.Scale1Weight;
    private decimal scale2Weight => ModbusService.Scale2Weight;
    private decimal netWeight => session != null ? WeighingService.GetNetIngredientWeight(scale1Weight) : 0;

    private int netProgress = 0;
    private int scale2Progress = 0;
    private (string statusColor, string statusIcon, string statusMessage, bool canComplete) netStatus;

    private List<Bowl> availableIngredientBowls = new();
    private List<Bowl> availableMixingBowls = new();
    private string selectedIngredientBowlCode = string.Empty;
    private decimal selectedIngredientBowlWeight = 0;
    private string selectedMixingBowlCode = string.Empty;
    private decimal selectedMixingBowlWeight = 0;
    private bool ingredientBowlVerified = false;
    private bool mixingBowlVerified = false;
    private string currentLoggedInUser = "";
    private bool showValidation = false;
    private string abortReason = "";
    private string abortedBy = "";

    protected override async Task OnInitializedAsync()
    {
        if (AuthService.CurrentUser != null)
        {
            currentLoggedInUser = AuthService.CurrentUser.Username;
        }
        else
        {
            currentLoggedInUser = "Unknown";
        }

        session = WeighingService.GetActiveSession();

        if (session == null && !string.IsNullOrEmpty(BatchId))
        {
            session = await WeighingService.StartWeighingSessionAsync(BatchId);
        }

        if (session != null)
        {
            await LoadAvailableBowls();
            UpdateStatus();
        }
    }

    private string GetPercentageColor(int percentage)
    {
        if (percentage < 40) return "#f56565";
        if (percentage < 70) return "#ed8936";
        if (percentage < 85) return "#ecc94b";
        if (percentage < 105) return "#48bb78";
        return "#f56565";
    }

    private async Task LoadAvailableBowls()
    {
        if (session?.CurrentIngredient == null) return;

        var allBowls = await BowlService.GetAllBowlsAsync();

        availableIngredientBowls = allBowls
            .Where(b => b.Category == BowlCategory.RegularBowl
                        && b.BowlType == session.CurrentIngredient.BowlSize
                        && b.Status == BowlStatus.Available)
            .ToList();

        availableMixingBowls = allBowls
            .Where(b => b.Category == BowlCategory.MixingBowl
                        && b.Status == BowlStatus.Available)
            .ToList();
    }

    private void OnIngredientBowlSelected()
    {
        if (string.IsNullOrEmpty(selectedIngredientBowlCode))
        {
            selectedIngredientBowlWeight = 0;
            ingredientBowlVerified = false;
            return;
        }

        var bowl = availableIngredientBowls.FirstOrDefault(b => b.BowlCode == selectedIngredientBowlCode);
        if (bowl != null)
        {
            selectedIngredientBowlWeight = bowl.Weight;
            ingredientBowlVerified = false;
        }
    }

    private void OnMixingBowlSelected()
    {
        if (string.IsNullOrEmpty(selectedMixingBowlCode))
        {
            selectedMixingBowlWeight = 0;
            mixingBowlVerified = false;
            return;
        }

        var bowl = availableMixingBowls.FirstOrDefault(b => b.BowlCode == selectedMixingBowlCode);
        if (bowl != null)
        {
            selectedMixingBowlWeight = bowl.Weight;
            mixingBowlVerified = false;
        }
    }

    private async Task VerifyIngredientBowl()
    {
        if (string.IsNullOrEmpty(selectedIngredientBowlCode))
        {
            await JSRuntime.InvokeVoidAsync("alert", "⚠️ Please select a bowl first!");
            return;
        }

        var result = WeighingService.VerifyBowlWeight(scale1Weight, selectedIngredientBowlWeight, selectedIngredientBowlCode, 0.05m);

        if (result.isValid)
        {
            ingredientBowlVerified = true;
            await JSRuntime.InvokeVoidAsync("alert", "✅ Bowl verified successfully!");
        }
        else
        {
            ingredientBowlVerified = false;
            await JSRuntime.InvokeVoidAsync("alert", $"❌ {result.message}");
        }
    }

    private async Task VerifyMixingBowl()
    {
        if (string.IsNullOrEmpty(selectedMixingBowlCode))
        {
            await JSRuntime.InvokeVoidAsync("alert", "⚠️ Please select a bowl first!");
            return;
        }

        var result = WeighingService.VerifyBowlWeight(scale2Weight, selectedMixingBowlWeight, selectedMixingBowlCode, 0.05m);

        if (result.isValid)
        {
            mixingBowlVerified = true;
            await JSRuntime.InvokeVoidAsync("alert", "✅ Bowl verified successfully!");
        }
        else
        {
            mixingBowlVerified = false;
            await JSRuntime.InvokeVoidAsync("alert", $"❌ {result.message}");
        }
    }

    private async Task RecordBowlsAndContinue()
    {
        if (session == null || !ingredientBowlVerified) return;
        if (session.CurrentIngredientIndex == 0 && !mixingBowlVerified) return;

        WeighingService.SelectBowls(
            session.BatchId,
            selectedIngredientBowlCode,
            selectedIngredientBowlWeight,
            selectedMixingBowlCode,
            selectedMixingBowlWeight
        );

        session.CurrentStage = WeighingStage.WeighIngredient;
        UpdateStatus();
    }

    private async Task StartModbusReading()
    {
        if (isModbusReading) return;

        if (session != null && !string.IsNullOrEmpty(currentLoggedInUser))
        {
            await WeighingService.UpdateSessionOperatorAsync(session.BatchId, currentLoggedInUser);
        }

        try
        {
            if (!isModbusConnected)
            {
                var connected = await ModbusService.ConnectAsync();
                if (!connected)
                {
                    await JSRuntime.InvokeVoidAsync("alert", "⚠️ Failed to connect to scales");
                    return;
                }
                isModbusConnected = true;
            }

            ModbusService.WeightUpdated += OnWeightUpdated;
            _cancellationTokenSource = new CancellationTokenSource();
            isModbusReading = true;

            _ = Task.Run(async () =>
            {
                try
                {
                    await ModbusService.StartReadingAsync(_cancellationTokenSource.Token);
                }
                catch (OperationCanceledException)
                {
                }
                catch (Exception ex)
                {
                    await InvokeAsync(async () =>
                    {
                        isModbusReading = false;
                        isModbusConnected = false;
                        await JSRuntime.InvokeVoidAsync("alert", $"❌ Scale error: {ex.Message}");
                        StateHasChanged();
                    });
                }
            });

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"❌ Error: {ex.Message}");
        }
    }

    private void StopModbusReading()
    {
        if (!isModbusReading) return;

        try
        {
            ModbusService.WeightUpdated -= OnWeightUpdated;
            _cancellationTokenSource?.Cancel();
            _cancellationTokenSource?.Dispose();
            _cancellationTokenSource = null;
            ModbusService.Disconnect();
            isModbusReading = false;
            isModbusConnected = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error stopping Modbus: {ex.Message}");
        }
    }

    private void OnWeightUpdated(decimal s1, decimal s2)
    {
        InvokeAsync(() =>
        {
            UpdateStatus();
            StateHasChanged();
        });
    }

    private void UpdateStatus()
    {
        if (session?.CurrentIngredient == null) return;

        if (session.CurrentStage == WeighingStage.WeighIngredient)
        {
            netStatus = WeighingService.GetIngredientStatusByNet(netWeight, session.CurrentIngredient);
            var targetWeight = session.CurrentIngredient.TargetWeight;
            netProgress = targetWeight > 0 ? Math.Min(100, (int)((netWeight / targetWeight) * 100)) : 0;
        }

        decimal netScale2Weight = scale2Weight - session.MixingBowlWeightBefore;
        decimal totalRecipeWeight = session.Ingredients.Sum(i => i.TargetWeight);
        scale2Progress = totalRecipeWeight > 0 ? Math.Min(100, (int)((netScale2Weight / totalRecipeWeight) * 100)) : 0;

        if (isInTransferStage && session != null)
        {
            decimal expectedCumulative = 0;
            for (int i = 0; i <= session.CurrentIngredientIndex; i++)
            {
                if (i < session.Ingredients.Count)
                    expectedCumulative += session.Ingredients[i].TargetWeight;
            }

            decimal netScale2 = scale2Weight - session.MixingBowlWeightBefore;
            transferWeightMatches = Math.Abs(netScale2 - expectedCumulative) <= 0.05m;
        }
    }

    // ✅ AUTO-SCROLL TO SCALE 2
    private async Task ReadyToTransfer()
    {
        if (session == null || !netStatus.canComplete) return;

        await WeighingService.ReadyToTransferAsync(session.BatchId, netWeight);
        isInTransferStage = true;
        transferWeightMatches = false;

        StateHasChanged();

        // ✅ AUTO-SCROLL TO SCALE 2 AFTER UI UPDATE
        await Task.Delay(150);
        await JSRuntime.InvokeVoidAsync("eval",
            "document.getElementById('scale2-card').scrollIntoView({ behavior: 'smooth', block: 'start' })");
    }

    private async Task ConfirmTransfer()
    {
        if (session == null) return;

        var (success, message, deviation) = await WeighingService.ConfirmTransferAsync(
            session.BatchId,
            scale2Weight);

        if (!success)
        {
            await JSRuntime.InvokeVoidAsync("alert", message);
            return;
        }

        isInTransferStage = false;
        transferWeightMatches = false;

        session = WeighingService.GetActiveSession();

        if (session == null)
        {
            StopModbusReading();
            await JSRuntime.InvokeVoidAsync("alert", "🎉 Batch completed successfully!");
            Navigation.NavigateTo("/production");
            return;
        }

        if (session.CurrentIngredientIndex == 0)
        {
            await JSRuntime.InvokeVoidAsync("alert",
                $"✅ Repetition {session.CurrentRepetition - 1} Complete!\n\n" +
                $"Starting Repetition {session.CurrentRepetition} of {session.TotalRepetitions}\n\n" +
                "Please select and verify BOTH bowls again.");

            selectedIngredientBowlCode = string.Empty;
            selectedIngredientBowlWeight = 0;
            ingredientBowlVerified = false;
            selectedMixingBowlCode = string.Empty;
            selectedMixingBowlWeight = 0;
            mixingBowlVerified = false;

            await LoadAvailableBowls();

            if (session != null)
            {
                session.CurrentStage = WeighingStage.PlaceBowls;
            }

            UpdateStatus();
            StateHasChanged();
            return;
        }

        await JSRuntime.InvokeVoidAsync("alert",
            $"✅ Transfer Complete!\n\n" +
            "Remove ingredient bowl from Scale 1.\n" +
            "Mixing bowl stays on Scale 2.\n\n" +
            "Ready for next ingredient.");

        selectedIngredientBowlCode = string.Empty;
        selectedIngredientBowlWeight = 0;
        ingredientBowlVerified = false;

        await LoadAvailableBowls();

        if (session != null)
        {
            session.CurrentStage = WeighingStage.PlaceBowls;
        }

        UpdateStatus();
        StateHasChanged();
    }

    private async Task PauseSession()
    {
        if (session == null) return;
        StopModbusReading();
        await WeighingService.PauseSessionAsync(session.BatchId);
        Navigation.NavigateTo("/production");
    }

    private void OpenAbortModal()
    {
        abortReason = "";
        abortedBy = currentLoggedInUser;
        showValidation = false;
        showAbortModal = true;
    }

    private void CloseAbortModal()
    {
        showAbortModal = false;
        showValidation = false;
        abortReason = "";
        abortedBy = "";
    }

    private async Task ConfirmAbort()
    {
        if (session == null) return;

        showValidation = true;

        if (string.IsNullOrWhiteSpace(abortReason) || string.IsNullOrWhiteSpace(abortedBy))
        {
            StateHasChanged();
            return;
        }

        StopModbusReading();
        await WeighingService.AbortSessionAsync(session.BatchId, abortReason, abortedBy);
        Navigation.NavigateTo("/production");
    }

    private void GoToProduction()
    {
        Navigation.NavigateTo("/production");
    }

    public void Dispose()
    {
        StopModbusReading();
    }
}